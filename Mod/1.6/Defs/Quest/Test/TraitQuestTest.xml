<?xml version="1.0" encoding="utf-8" ?>
<Defs>
  <HistoryEventDef>
    <defName>AnimeArsenal_BreathingMasteryTest</defName>
    <label>Breathing Mastery Test Completed</label>
  </HistoryEventDef>

  <HistoryEventDef>
    <defName>AnimeArsenal_BreathingMasteryFailed</defName>
    <label>Breathing Mastery Test Failed</label>
  </HistoryEventDef>

  <QuestScriptDef>
    <defName>AnimeArsenal_BreathingMasteryTest</defName>
    <rootSelectionWeight>5.0</rootSelectionWeight>
    <rootMinPoints>500</rootMinPoints>
    <rootEarliestDay>1</rootEarliestDay>
    <minRefireDays>1</minRefireDays>
    <expireDaysRange>3~7</expireDaysRange>
    <epic>false</epic>
    <isRootSpecial>true</isRootSpecial>
    <questAvailableLetterLabel>Breathing Mastery Test</questAvailableLetterLabel>
    <questAvailableLetterDef>PositiveEvent</questAvailableLetterDef>
    <successHistoryEvent>AnimeArsenal_BreathingMasteryTest</successHistoryEvent>
    <failedOrExpiredHistoryEvent>AnimeArsenal_BreathingMasteryFailed</failedOrExpiredHistoryEvent>

    <questNameRules>
      <rulesStrings>
        <li>questName->Breathing Mastery Test</li>
        <li>questName->Advanced Training</li>
        <li>questName->Trait Awakening Trial</li>
      </rulesStrings>
    </questNameRules>

    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->A master trainer has arrived offering advanced breathing technique training. They can help those with existing breathing genes unlock their true potential through specialized trait development.\n\nSend three colonists with breathing genes for intensive training. Those with Beast, Flame, or Flower breathing techniques may discover unique combat abilities.\n\nThis is a test quest with high survival rates for testing purposes.</li>
      </rulesStrings>
    </questDescriptionRules>

    <root Class="QuestNode_Sequence">
      <nodes>
        <li Class="QuestNode_GetPawn">
          <storeAs>asker</storeAs>
          <mustBeFactionLeader>true</mustBeFactionLeader>
          <mustBeNonHostileToPlayer>true</mustBeNonHostileToPlayer>
          <factionMustBePermanent>true</factionMustBePermanent>
        </li>

        <li Class="QuestNode_Set">
          <name>trainingDays</name>
          <value>2</value>
        </li>

        <li Class="QuestNode_GetMap">
          <storeAs>map</storeAs>
          <preferMapWithMinFreeColonists>1</preferMapWithMinFreeColonists>
        </li>

        <li Class="AnimeArsenal.QuestNode_GetFlexibleRewards">
          <customSurvivalMessage>{PAWNS} completed the breathing mastery training and unlocked new abilities!</customSurvivalMessage>
          <customDeathMessage>{PAWN} failed the intensive training and was lost.</customDeathMessage>
          <customRewardMessage>{PAWN} mastered {REWARD} through intense breathing training!</customRewardMessage>

          <flexibleRewards>

            <!-- Beast Breathing specific traits -->
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>PackHunter</traitDef>
              <traitDegree>1</traitDegree>
              <weight>8</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_BeastBreath</geneDef>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>WildSenses</traitDef>
              <traitDegree>1</traitDegree>
              <weight>6</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_BeastBreath</geneDef>
                </li>
              </requirements>
            </li>

            <!-- Flame Breathing specific traits -->
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>InnerFire</traitDef>
              <traitDegree>1</traitDegree>
              <weight>10</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_FlameBreath</geneDef>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>BurningPassion</traitDef>
              <traitDegree>1</traitDegree>
              <weight>6</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_FlameBreath</geneDef>
                </li>
              </requirements>
            </li>

            <!-- Flower Breathing specific traits -->
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>BotanicalKnowledge</traitDef>
              <traitDegree>1</traitDegree>
              <weight>8</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_FlowerBreath</geneDef>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>GraceUnderPressure</traitDef>
              <traitDegree>1</traitDegree>
              <weight>6</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_FlowerBreath</geneDef>
                </li>
              </requirements>
            </li>

            <!-- Special combo traits for testing multiple requirements -->
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>Optimist</traitDef>
              <weight>4</weight>
              <requirements>
                <li>
                  <requirementType>HasGene</requirementType>
                  <geneDef>Gene_FlowerBreath</geneDef>
                </li>
                <li>
                  <requirementType>SkillLevel</requirementType>
                  <skillDef>Social</skillDef>
                  <minimumValue>6</minimumValue>
                </li>
              </requirements>
            </li>
          </flexibleRewards>

          <survivalSettings>
            <baseSurvivalChance>0.95</baseSurvivalChance>
            <minimumSurvivalChance>0.9</minimumSurvivalChance>
            <maximumSurvivalChance>0.99</maximumSurvivalChance>

            <skillBonuses>
              <li>
                <skillDef>Melee</skillDef>
                <minimumLevel>5</minimumLevel>
                <bonus>0.02</bonus>
              </li>
            </skillBonuses>

            <traitModifiers>
              <li>
                <traitDef>Tough</traitDef>
                <modifier>0.01</modifier>
              </li>
            </traitModifiers>
          </survivalSettings>
        </li>

        <li Class="QuestNode_ShuttleDelay">
          <delayTicks>1500</delayTicks>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_SubScript">
                <def>Util_TransportShip_Pickup</def>
                <parms>
                  <leaveDelayTicks>30000</leaveDelayTicks>
                  <leaveImmediatelyWhenSatisfied>true</leaveImmediatelyWhenSatisfied>
                  <acceptColonists>true</acceptColonists>
                  <acceptChildren>false</acceptChildren>
                  <onlyAcceptColonists>true</onlyAcceptColonists>
                  <onlyAcceptHealthy>true</onlyAcceptHealthy>
                  <requireColonistCount>3</requireColonistCount>
                </parms>
              </li>

              <li Class="QuestNode_Letter">
                <label>Breathing Master Arrived</label>
                <text>A breathing technique master has arrived for advanced training. They specialize in unlocking hidden potential in those who already possess breathing genes.\n\n"Send me three students with breathing abilities. I will help them discover traits that complement their natural gifts. Beast breathers become fierce warriors, flame breathers gain precision, and flower breathers develop empathy."\n\nThis is a test quest with very high survival rates.</text>
                <lookTargets>$pickupShipThing</lookTargets>
              </li>
            </nodes>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>pickupShipThing.SentSatisfied</inSignal>
          <node Class="QuestNode_LendColonistsToFaction">
            <shuttle>$pickupShipThing</shuttle>
            <lendColonistsToFactionOf>$asker</lendColonistsToFactionOf>
            <returnLentColonistsInTicks>$($trainingDays*60000)</returnLentColonistsInTicks>
            <outSignalComplete>ColonistsReturned</outSignalComplete>
            <outSignalColonistsDied>ColonistsDied</outSignalColonistsDied>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>ColonistsReturned</inSignal>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Letter">
                <label>Training Complete</label>
                <text>The breathing mastery training is complete. Let's see what traits your colonists unlocked!</text>
                <letterDef>NeutralEvent</letterDef>
                <useColonistsFromCaravanArg>true</useColonistsFromCaravanArg>
              </li>

              <li Class="QuestNode_End">
                <outcome>Success</outcome>
              </li>
            </nodes>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>ColonistsDied</inSignal>
          <node Class="QuestNode_Letter">
            <label>Training Failed</label>
            <text>The intensive training was too much for some of your colonists. They did not survive the process.</text>
            <letterDef>Death</letterDef>
          </node>
        </li>
      </nodes>
    </root>
  </QuestScriptDef>
</Defs>
