<?xml version="1.0" encoding="utf-8" ?>
<Defs>
  <HistoryEventDef>
    <defName>AnimeArsenal_PrimalAwakeningCompleted</defName>
    <label>Primal Awakening Completed</label>
  </HistoryEventDef>

  <HistoryEventDef>
    <defName>AnimeArsenal_PrimalAwakeningFailed</defName>
    <label>Primal Awakening Failed</label>
  </HistoryEventDef>

  <QuestScriptDef>
    <defName>AnimeArsenal_BeastBreathingTraining</defName>
    <rootSelectionWeight>0.3</rootSelectionWeight>
    <rootMinPoints>600</rootMinPoints>
    <rootEarliestDay>20</rootEarliestDay>
    <minRefireDays>80</minRefireDays>
    <expireDaysRange>4~8</expireDaysRange>
    <isRootSpecial>false</isRootSpecial>
    <questAvailableLetterLabel>Beast Breathing Training</questAvailableLetterLabel>
    <questAvailableLetterDef>PositiveEvent</questAvailableLetterDef>
    <successHistoryEvent>AnimeArsenal_PrimalAwakeningCompleted</successHistoryEvent>
    <failedOrExpiredHistoryEvent>AnimeArsenal_PrimalAwakeningFailed</failedOrExpiredHistoryEvent>

    <questNameRules>
      <rulesStrings>
        <li>questName->Beast Breathing Training</li>
        <li>questName->The Way of the Beast</li>
        <li>questName->Savage Breath Techniques</li>
        <li>questName->Primal Breathing Forms</li>
        <li>questName->Beast Style Mastery</li>
      </rulesStrings>
    </questNameRules>
    <questDescriptionRules>
      <rulesStrings>
        <li>questDescription->A former Beast Hashira has emerged from the wild mountains, seeking students willing to learn the savage art of Beast Breathing. This brutal training focuses on unleashing one's primal instincts and fighting with the ferocity of wild animals.\n\n"Civilization makes you weak! Beast Breathing strips away your fancy manners and awakens the predator within. Those who master it become like wild beasts - faster, stronger, more dangerous than any tame human!"\n\n The training is harsh and transformative. Students will gain animal-like instincts and combat abilities, though they may become less suited for delicate civilized work. Physical prowess and mental toughness determine success.</li>
      </rulesStrings>
    </questDescriptionRules>
    <root Class="QuestNode_Sequence">
      <nodes>

        <li Class="QuestNode_GetPawn">
          <storeAs>asker</storeAs>
          <mustBeFactionLeader>true</mustBeFactionLeader>
          <mustBeNonHostileToPlayer>true</mustBeNonHostileToPlayer>
          <factionMustBePermanent>true</factionMustBePermanent>
          <excludeFactionDefs>
            <li>AA_Twelve_Demon_Moons</li>
          </excludeFactionDefs>
        </li>

        <li Class="QuestNode_Set">
          <name>trainingDays</name>
          <value>5</value>
        </li>

        <li Class="QuestNode_GetMap">
          <storeAs>map</storeAs>
          <preferMapWithMinFreeColonists>1</preferMapWithMinFreeColonists>
        </li>

        <!-- Beast Breathing Training with feral trait rewards -->
        <li Class="AnimeArsenal.QuestNode_GetFlexibleRewards">
          <flexibleRewards>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>FeralInstincts</traitDef>
              <traitDegree>1</traitDegree>
              <weight>3</weight>
              <requirements>
                <li>
                  <requirementType>DoesNotHaveTrait</requirementType>
                  <traitDef>FeralInstincts</traitDef>
                </li>
                <li>
                  <requirementType>SkillLevel</requirementType>
                  <skillDef>Melee</skillDef>
                  <minimumValue>4</minimumValue>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>PackHunter</traitDef>
              <traitDegree>1</traitDegree>
              <weight>3</weight>
              <requirements>
                <li>
                  <requirementType>DoesNotHaveTrait</requirementType>
                  <traitDef>PackHunter</traitDef>
                </li>
                <li>
                  <requirementType>SkillLevel</requirementType>
                  <skillDef>Shooting</skillDef>
                  <minimumValue>3</minimumValue>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>WildSenses</traitDef>
              <traitDegree>1</traitDegree>
              <weight>3</weight>
              <requirements>
                <li>
                  <requirementType>DoesNotHaveTrait</requirementType>
                  <traitDef>WildSenses</traitDef>
                </li>
                <li>
                  <requirementType>SkillLevel</requirementType>
                  <skillDef>Animals</skillDef>
                  <minimumValue>2</minimumValue>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>Territorial</traitDef>
              <traitDegree>1</traitDegree>
              <weight>2</weight>
              <requirements>
                <li>
                  <requirementType>DoesNotHaveTrait</requirementType>
                  <traitDef>Territorial</traitDef>
                </li>
                <li>
                  <requirementType>SkillLevel</requirementType>
                  <skillDef>Construction</skillDef>
                  <minimumValue>3</minimumValue>
                </li>
              </requirements>
            </li>
            <li>
              <rewardType>Trait</rewardType>
              <traitDef>PrimalRage</traitDef>
              <traitDegree>1</traitDegree>
              <weight>4</weight>
              <requirements>
                <li>
                  <requirementType>DoesNotHaveTrait</requirementType>
                  <traitDef>PrimalRage</traitDef>
                </li>
                <li>
                  <requirementType>SkillLevel</requirementType>
                  <skillDef>Melee</skillDef>
                  <minimumValue>5</minimumValue>
                </li>
              </requirements>
            </li>
          </flexibleRewards>

          <survivalSettings>
            <baseSurvivalChance>0.85</baseSurvivalChance> <!-- More dangerous than water training -->
            <minimumSurvivalChance>0.6</minimumSurvivalChance>
            <maximumSurvivalChance>0.98</maximumSurvivalChance>

            <skillBonuses>
              <li>
                <skillDef>Melee</skillDef>
                <minimumLevel>6</minimumLevel>
                <bonus>0.05</bonus>
              </li>
              <li>
                <skillDef>Animals</skillDef>
                <minimumLevel>5</minimumLevel>
                <bonus>0.04</bonus>
              </li>
              <li>
                <skillDef>Shooting</skillDef>
                <minimumLevel>4</minimumLevel>
                <bonus>0.03</bonus>
              </li>
              <li>
                <skillDef>Construction</skillDef>
                <minimumLevel>6</minimumLevel>
                <bonus>0.02</bonus>
              </li>
            </skillBonuses>

            <traitModifiers>
              <li>
                <traitDef>Tough</traitDef>
                <modifier>0.05</modifier>
              </li>
              <li>
                <traitDef>Brawler</traitDef>
                <modifier>0.04</modifier>
              </li>
              <li>
                <traitDef>Wimp</traitDef>
                <modifier>-0.15</modifier>
              </li>
              <li>
                <traitDef>SlowLearner</traitDef>
                <modifier>-0.08</modifier>
              </li>
              <li>
                <traitDef>Beauty</traitDef>
                <modifier>-0.03</modifier>
              </li>
            </traitModifiers>
          </survivalSettings>

          <!-- Custom messages -->
          <customSurvivalMessage>{PAWNS} survived the brutal Beast Breathing training and awakened their primal nature!</customSurvivalMessage>
          <customDeathMessage>{PAWN} couldn't handle the savage training and was overwhelmed by their unleashed instincts.</customDeathMessage>
          <customRewardMessage>{PAWN} has awakened {REWARD} through the wild Beast Breathing techniques!</customRewardMessage>
        </li>

        <li Class="QuestNode_ShuttleDelay">
          <delayTicks>2500</delayTicks>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_SubScript">
                <def>Util_TransportShip_Pickup</def>
                <parms>
                  <leaveDelayTicks>120000</leaveDelayTicks>
                  <leaveImmediatelyWhenSatisfied>true</leaveImmediatelyWhenSatisfied>
                  <acceptColonists>true</acceptColonists>
                  <acceptChildren>false</acceptChildren>
                  <onlyAcceptColonists>true</onlyAcceptColonists>
                  <onlyAcceptHealthy>true</onlyAcceptHealthy>
                  <requireColonistCount>2</requireColonistCount> <!-- Max 2 students -->
                </parms>
              </li>

              <li Class="QuestNode_Letter">
                <label>Beast Hashira Training Opportunity</label>
                <text>A wild-looking warrior has arrived at your settlement, claiming to be a former Beast Hashira. Their presence makes even your toughest colonists nervous.\n\n"I smell weakness in your people! But some have potential... I will teach two students the way of Beast Breathing. Fair warning - this training will change them forever. They'll become stronger, faster, more dangerous... but they may never be the same civilized people they once were."\n\nThis is a rare chance to learn one of the most savage breathing techniques, though the training comes with serious risks to both body and mind.</text>
                <lookTargets>$pickupShipThing</lookTargets>
              </li>
            </nodes>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>pickupShipThing.SentSatisfied</inSignal>
          <node Class="QuestNode_LendColonistsToFaction">
            <shuttle>$pickupShipThing</shuttle>
            <lendColonistsToFactionOf>$asker</lendColonistsToFactionOf>
            <returnLentColonistsInTicks>$($trainingDays*60000)</returnLentColonistsInTicks>
            <outSignalComplete>ColonistsReturned</outSignalComplete>
            <outSignalColonistsDied>ColonistsDied</outSignalColonistsDied>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>ColonistsReturned</inSignal>
          <node Class="QuestNode_Sequence">
            <nodes>
              <li Class="QuestNode_Letter">
                <label>Beast Training Complete</label>
                <text>Your colonists have returned from their Beast Breathing training. They move differently now - more like predators than people. The master grins with savage approval...</text>
                <letterDef>NeutralEvent</letterDef>
                <useColonistsFromCaravanArg>true</useColonistsFromCaravanArg>
              </li>

              <li Class="QuestNode_End">
                <outcome>Success</outcome>
              </li>
            </nodes>
          </node>
        </li>

        <li Class="QuestNode_Signal">
          <inSignal>ColonistsDied</inSignal>
          <node Class="QuestNode_Letter">
            <label>Training Disaster</label>
            <text>The Beast Breathing training proved too intense. Your colonist was consumed by their unleashed primal nature and could not return to civilized life.</text>
            <letterDef>Death</letterDef>
          </node>
        </li>
      </nodes>
    </root>
  </QuestScriptDef>
</Defs>
